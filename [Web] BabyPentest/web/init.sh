#!/usr/bin/env bash
set -euo pipefail

WP_PATH="/var/www/wordpress/assets/fonts/blog"
DB_HOST="${WP_DB_HOST:-db}"
DB_NAME="${WP_DB_NAME:-wordpress}"
DB_USER="${WP_DB_USER:-root}"
DB_PASS="${WP_DB_PASS:-sup3r_s3cr3t}"
SITE_URL="${WP_SITE_URL:-http://blogger.chw:8080/assets/fonts/blog}"

export WP_CLI_ALLOW_ROOT=1

echo "[*] Waiting for DB at ${DB_HOST}..."
until mysql -h "${DB_HOST}" -u"${DB_USER}" -p"${DB_PASS}" -e "SELECT 1" >/dev/null 2>&1; do
  sleep 2
done
echo "[*] DB is up."

# --- seed  ---
mkdir -p /var/www/wordpress/assets
if [ ! -f /var/www/wordpress/index.html ]; then
  cp -a /opt/bootstrap/index.html /var/www/wordpress/index.html
fi
cp -a /opt/bootstrap/assets/. /var/www/wordpress/assets/
chown -R www-data:www-data /var/www/wordpress
# --- end seed ---

if [ ! -f "${WP_PATH}/wp-config.php" ]; then
  echo "[*] Downloading WordPress 5.4.2..."
  mkdir -p "${WP_PATH}"
  curl -sSL -o /tmp/wordpress.tar.gz https://wordpress.org/wordpress-5.4.2.tar.gz
  tar -xzf /tmp/wordpress.tar.gz -C /tmp
  shopt -s dotglob
  rm -rf "${WP_PATH:?}/"*
  cp -a /tmp/wordpress/. "${WP_PATH}/"

  echo "[*] Setting up wp-config..."
  wp config create \
    --dbname="${DB_NAME}" \
    --dbuser="${DB_USER}" \
    --dbpass="${DB_PASS}" \
    --dbhost="${DB_HOST}" \
    --path="${WP_PATH}" \
    --skip-check \
    --force \
    --allow-root

  wp config set WP_HOME    "${SITE_URL}" --type=constant --path="${WP_PATH}" --allow-root
  wp config set WP_SITEURL "${SITE_URL}" --type=constant --path="${WP_PATH}" --allow-root

  echo "[*] Installing WordPress..."
  wp core install \
    --url="${SITE_URL}" \
    --title="CHW Blogger" \
    --admin_user="admin" \
    --admin_password="ChangeMe!123" \
    --admin_email="admin@blogger.thm" \
    --path="${WP_PATH}" \
    --allow-root

  echo "[*] Installing plugins (no activate yet)..."
  if ! wp plugin is-installed wpdiscuz --path="${WP_PATH}" --allow-root; then
    wp plugin install wpdiscuz --version=7.0.4 --path="${WP_PATH}" --allow-root
  fi

  if ! wp user get "j@m3s" --field=ID --path="${WP_PATH}" --allow-root >/dev/null 2>&1; then
    wp user create "j@m3s" "admin@blogger.thm" \
      --role=author --user_pass="NoLoginHere" \
      --path="${WP_PATH}" --display_name="j@m3s" \
      --allow-root || true
  fi

  chown -R www-data:www-data "${WP_PATH}"
fi

if wp core is-installed --path="${WP_PATH}" --allow-root; then
  echo "[*] Post-setup stabilization..."

  wp option update home    "${SITE_URL}" --path="${WP_PATH}" --allow-root
  wp option update siteurl "${SITE_URL}" --path="${WP_PATH}" --allow-root

  mkdir -p "${WP_PATH}/wp-content/mu-plugins"
  cp -a /opt/bootstrap/mu-plugins/. "${WP_PATH}/wp-content/mu-plugins/"
  chown -R www-data:www-data "${WP_PATH}/wp-content/mu-plugins"

  if ! wp plugin is-installed wpdiscuz --path="${WP_PATH}" --allow-root; then
    wp plugin install wpdiscuz --version=7.0.4 --path="${WP_PATH}" --allow-root
  fi
  wp plugin activate wpdiscuz --path="${WP_PATH}" --allow-root || true

  wp option update default_comment_status open   --path="${WP_PATH}" --allow-root
  wp option update comment_moderation 0          --path="${WP_PATH}" --allow-root
  wp option update comment_previously_approved 1 --path="${WP_PATH}" --allow-root

  for ID in $(wp post list --post_type=post --format=ids --path="${WP_PATH}" --allow-root); do
    wp post update "$ID" --comment_status=open --path="${WP_PATH}" --allow-root
  done

  TARGET=41
  while true; do
    HAS=$(wp db query "SELECT ID FROM wp_posts WHERE ID=${TARGET} LIMIT 1" \
          --skip-column-names --path="${WP_PATH}" --allow-root || true)
    [ "$HAS" = "$TARGET" ] && break
    wp post create --post_title="CHW Note" --post_content="Welcome to CHW Blogger." \
      --post_status=publish --porcelain --path="${WP_PATH}" --allow-root >/dev/null
    sleep 0.1
  done
  wp post update 41 --comment_status=open --path="${WP_PATH}" --allow-root

  chown -R www-data:www-data "${WP_PATH}"
fi
# ===== end stabilization =====

echo "[*] Init done."
