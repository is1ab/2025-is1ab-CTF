FROM wordpress:5.4.2-php7.4-apache

ENV DEBIAN_FRONTEND=noninteractive
ENV WP_CLI_ALLOW_ROOT=1

RUN set -eux; \
    printf 'deb http://archive.debian.org/debian buster main\n' >  /etc/apt/sources.list; \
    printf 'deb http://archive.debian.org/debian-security buster/updates main\n' >> /etc/apt/sources.list; \
    printf 'Acquire::Check-Valid-Until "false";\n' > /etc/apt/apt.conf.d/99no-check-valid; \
    apt-get -o Acquire::Check-Valid-Until=false update; \
    apt-get install -y --no-install-recommends \
        openssh-server sudo supervisor mariadb-client \
        curl wget unzip less nano netcat-traditional iputils-ping python3; \
    rm -rf /var/lib/apt/lists/*

RUN a2enmod rewrite headers autoindex
COPY apache.conf /etc/apache2/sites-available/000-default.conf
COPY index.html /opt/bootstrap/index.html
COPY assets/    /opt/bootstrap/assets/

# MU-plugin
COPY assets/mu-plugins/chw-wpdiscuz-poc-helper.php /opt/bootstrap/mu-plugins/chw-wpdiscuz-poc-helper.php

# Supervisor
COPY supervisor/services.conf /etc/supervisor/conf.d/services.conf

COPY flags/root.txt /root/root_flag.txt
COPY flags/user.txt /home/user_flag.txt

RUN set -eux; \
    chmod 600 /root/root_flag.txt; \
    useradd -m -u 1001 -s /bin/bash vagrant; \
    echo 'vagrant:vagrant' | chpasswd; \
    usermod -aG sudo vagrant; \
    printf 'vagrant ALL=(ALL) NOPASSWD:ALL\n' > /etc/sudoers.d/90-vagrant; \
    chmod 0440 /etc/sudoers.d/90-vagrant; \
    useradd -m -u 1002 -s /bin/bash chwast; \
    useradd -m -u 1003 -s /bin/bash sophia; \
    mkdir -p /home/chwast /home/sophia; \
    chown -R chwast:chwast /home/chwast; \
    chown -R sophia:sophia /home/sophia; \
    mkdir -p /var/run/sshd

# --- SSH ---
RUN set -eux; \
  if grep -q '^PasswordAuthentication' /etc/ssh/sshd_config; then \
      sed -i 's/^PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config; \
    else echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config; fi; \
  if grep -q '^UsePAM' /etc/ssh/sshd_config; then \
      sed -i 's/^UsePAM .*/UsePAM yes/' /etc/ssh/sshd_config; \
    else echo 'UsePAM yes' >> /etc/ssh/sshd_config; fi; \
  if grep -q '^ChallengeResponseAuthentication' /etc/ssh/sshd_config; then \
      sed -i 's/^ChallengeResponseAuthentication .*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config; \
    else echo 'ChallengeResponseAuthentication no' >> /etc/ssh/sshd_config; fi; \
  if grep -q '^PermitRootLogin' /etc/ssh/sshd_config; then \
      sed -i 's/^PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config; \
    else echo 'PermitRootLogin no' >> /etc/ssh/sshd_config; fi; \
  ssh-keygen -A

# wp-cli
RUN curl -sSLo /usr/local/bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
 && chmod +x /usr/local/bin/wp

# init.sh
COPY init.sh /usr/local/bin/init.sh
RUN chmod +x /usr/local/bin/init.sh

# Priv
RUN mkdir -p /var/www/html && chown -R www-data:www-data /var/www

CMD ["/bin/bash", "-lc", "/usr/local/bin/init.sh && exec /usr/bin/supervisord -c /etc/supervisor/conf.d/services.conf"]
