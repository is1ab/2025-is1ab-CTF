<?php
/**
 * CHW wpDiscuz PoC helper (MU-Plugin)
 * - wmuSecurity / wc_post_id
 * - 提供 action=wmuUploadFiles 的後備 AJAX handler（未啟用或驗證失敗也能上傳）
 */

defined('ABSPATH') || exit;

add_action('wp_head', function () {
    if (!is_singular()) { return; }
    $pid   = get_queried_object_id();
    $nonce = wp_create_nonce('wmuSecurity');
    echo '<script>var wmuSecurity="'.esc_js($nonce).'", wc_post_id="'.esc_js((string)$pid).'";</script>' . "\n";
}, 20);

add_action('init', function () {
    global $wp_filter;

    $tag1 = 'wp_ajax_nopriv_wmuUploadFiles';
    $has1 = isset($wp_filter[$tag1]) && !empty($wp_filter[$tag1]->callbacks);
    if (!$has1) {
        add_action('wp_ajax_nopriv_wmuUploadFiles', 'chw_wmu_upload_shim');
    }

    $tag2 = 'wp_ajax_wmuUploadFiles';
    $has2 = isset($wp_filter[$tag2]) && !empty($wp_filter[$tag2]->callbacks);
    if (!$has2) {
        add_action('wp_ajax_wmuUploadFiles', 'chw_wmu_upload_shim');
    }
});

function chw_wmu_upload_shim() {
    $file = null;
    if (isset($_FILES['wmu_files'])) {
        $a = $_FILES['wmu_files'];
        if (is_array($a['name'])) {
            $file = [
                'name'     => $a['name'][0],
                'type'     => $a['type'][0],
                'tmp_name' => $a['tmp_name'][0],
                'error'    => $a['error'][0],
                'size'     => $a['size'][0],
            ];
        } else {
            $file = $a;
        }
    } elseif (!empty($_FILES)) {
        $k = array_key_first($_FILES);
        $file = $_FILES[$k];
    }

    if (!$file || !is_uploaded_file($file['tmp_name'])) {
        echo 0;
        wp_die();
    }

    $uploads = wp_upload_dir();
    if (!wp_mkdir_p($uploads['path'])) {
        echo 0;
        wp_die();
    }

    $basename = basename($file['name']);
    $target   = $uploads['path'] . '/' . $basename;
    $i = 1;
    while (file_exists($target)) {
        $pi  = pathinfo($basename);
        $alt = $pi['filename'] . '-' . $i . (isset($pi['extension']) && $pi['extension'] !== '' ? '.' . $pi['extension'] : '');
        $target   = $uploads['path'] . '/' . $alt;
        $basename = $alt;
        $i++;
    }

    if (!@move_uploaded_file($file['tmp_name'], $target)) {
        echo 0;
        wp_die();
    }
    @chmod($target, 0644);

    $url = trailingslashit($uploads['url']) . $basename;

    header('Content-Type: application/json; charset=utf-8');
    echo json_encode([
        'success' => true,
        'data'    => [ [ 'url' => $url ] ],
    ]);
    wp_die();
}
